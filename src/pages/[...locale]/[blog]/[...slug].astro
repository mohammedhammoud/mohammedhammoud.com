---
import { render } from "astro:content";
import MainLayout from "@shared/layouts/Main.astro";
import { toLocale } from "@i18n/to-locale";
import { generateBlogPostPaths } from "@features/blog/utils/generate-blog-post-paths";
import FormattedDate from "@shared/components/FormattedDate.astro";
import { useTranslations } from "@i18n/use-translations";
import { calculateReadingTime } from "@shared/utils/calculate-reading-time";
import { resolvePath } from "@shared/utils/resolve-path";
import { C } from "@/site.config";
import { LOCALE_PARAM_MAP } from "@shared/utils/locale-param-map";
import sluggify from "limax";
import Chip from "@shared/components/Chip.astro";

export async function getStaticPaths() {
  return generateBlogPostPaths();
}

const props = Astro.props;
const locale = toLocale(props.data.locale);
const t = useTranslations(locale);
const { Content } = await render(props);
const readingTimeMinutes = calculateReadingTime(props.body);
const blogSegment = C.SEGMENT_TRANSLATIONS[locale].blog;
const localeParam = LOCALE_PARAM_MAP[locale];
---

<MainLayout
  title={props.data.title}
  description={props.data.description}
  locale={locale}
  localeUrls={props.translations}
  activeTab="blog"
>
  <article class="mx-auto max-w-2xl">
    <header class="mb-12 text-center">
      <div
        class="mb-4 flex flex-wrap items-center justify-center gap-2 text-sm tracking-wide text-gray-500 uppercase dark:text-gray-400"
      >
        <time data-testid="blog-post-date">
          <FormattedDate date={props.data.publishedAt} locale={locale} />
        </time>
        <span aria-hidden="true">â€¢</span>
        <span>{t("blog.readingTime", { minutes: readingTimeMinutes })}</span>
      </div>
      {
        props.data.tags.length > 0 && (
          <div
            class="mb-6 flex flex-wrap justify-center gap-2"
            data-testid="blog-post-tags"
          >
            {props.data.tags.map((tag) => (
              <Chip
                href={resolvePath(
                  localeParam,
                  blogSegment,
                  "tag",
                  sluggify(tag),
                )}
              >
                {tag}
              </Chip>
            ))}
          </div>
        )
      }
      <h1
        class="text-5xl leading-tight font-bold text-gray-900 dark:text-white"
        data-testid="blog-post-title"
      >
        {props.data.title}
      </h1>
    </header>
    <div
      class="prose dark:prose-invert max-w-none"
      data-testid="blog-post-content"
    >
      <Content />
    </div>
  </article>
</MainLayout>
